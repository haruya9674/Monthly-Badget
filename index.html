<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json?v=FINAL2">
<meta name="theme-color" content="#4CAF93">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#F4F6F5;
}
header{
  background:#4CAF93;
  color:#fff;
  padding:18px;
  font-size:22px;
  text-align:center;
  font-weight:600;
}
.container{ padding:20px; }
select,input,button{
  width:100%;
  padding:14px;
  font-size:16px;
  border-radius:12px;
  border:none;
  margin-top:12px;
}
input{ border:1px solid #ccc; background:#fff; }
button{ background:#4CAF93;color:#fff;font-weight:bold; }
button.back{ background:#ddd;color:#333; }
button.sub{ background:#eee;color:#555;font-weight:500;font-size:14px; }
button.delete{ background:#E57373;margin-top:8px; }
.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
.hidden{ display:none; }
.expense{
  padding:16px 0;
  border-bottom:1px solid #eee;
  text-align:center;
}
.category{ font-size:15px;color:#666; }
.amount{ font-size:26px;font-weight:600;margin-top:4px; }
.total{
  font-size:28px;
  font-weight:700;
  text-align:center;
  margin:10px 0;
}
.breakdown{
  font-size:15px;
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}
</style>
</head>

<body>
<header id="title"></header>

<div class="container">

<div class="card">
  <select id="lang"></select>
  <select id="currency">
    <option value="MYR">MYR</option>
    <option value="JPY">JPY</option>
    <option value="KRW">KRW</option>
    <option value="AUD">AUD</option>
  </select>
</div>

<div id="menu" class="card">
  <button id="btnAdd"></button>
  <button id="btnSummary"></button>
</div>

<div id="add" class="card hidden">
  <select id="category"></select>
  <input type="number" id="amount">
  <button id="btnSave"></button>
  <button class="back" id="btnBack1"></button>
</div>

<div id="summary" class="card hidden">
  <select id="month"></select>

  <div id="monthTotal" class="total"></div>
  <div id="categoryTotal"></div>

  <hr>

  <div id="list"></div>

  <!-- 折りたたみ -->
  <button class="sub" id="toggleExport"></button>
  <div id="exportArea" class="hidden">
    <button class="sub" id="btnExcel"></button>
    <button class="sub" id="btnPDF"></button>
    <button class="sub" id="btnExportFamily"></button>
    <button class="sub" id="btnImportFamily"></button>
    <input type="file" id="familyFile" accept=".json" hidden>
  </div>

  <button class="back" id="btnBack2"></button>
</div>

</div>

<script>
/* ===== 言語 ===== */
const TEXT={
  ja:{
    title:"家計簿",add:"支出を入力",summary:"集計を見る",
    save:"保存",back:"戻る",amount:"金額",
    export:"エクスポート / 共有",
    excel:"Excelで書き出し",
    pdf:"PDFで書き出し",
    famExp:"家族共有用に書き出し",
    famImp:"家族共有データを読み込み"
  },
  en:{
    title:"Expense Tracker",add:"Add Expense",summary:"View Summary",
    save:"Save",back:"Back",amount:"Amount",
    export:"Export / Share",
    excel:"Export Excel",
    pdf:"Export PDF",
    famExp:"Export for Family",
    famImp:"Import Family Data"
  },
  ko:{
    title:"가계부",add:"지출 입력",summary:"집계 보기",
    save:"저장",back:"뒤로",amount:"금액",
    export:"내보내기 / 공유",
    excel:"엑셀로 내보내기",
    pdf:"PDF로 내보내기",
    famExp:"가족 공유용 내보내기",
    famImp:"가족 데이터 불러오기"
  }
};

const CAT={
  food:{ja:"食費",en:"Food",ko:"식비"},
  rent:{ja:"家賃",en:"Rent",ko:"월세"},
  utilities:{ja:"光熱費",en:"Utilities",ko:"공과금"},
  internet:{ja:"インターネット",en:"Internet",ko:"인터넷"},
  phone:{ja:"携帯",en:"Mobile",ko:"휴대폰"},
  school:{ja:"学費",en:"School",ko:"학비"},
  shopping:{ja:"買い物",en:"Shopping",ko:"쇼핑"},
  other:{ja:"その他",en:"Other",ko:"기타"}
};

let langVal = localStorage.getItem("lang") || "ja";
let activeId=null;

/* ===== 保存 ===== */
const load=()=>JSON.parse(localStorage.getItem("kakeibo_data")||"[]");
const saveAll=d=>localStorage.setItem("kakeibo_data",JSON.stringify(d));

function applyLang(){
  const t=TEXT[langVal];
  title.textContent=t.title;
  btnAdd.textContent=t.add;
  btnSummary.textContent=t.summary;
  btnSave.textContent=t.save;
  btnBack1.textContent=btnBack2.textContent=t.back;
  amount.placeholder=t.amount;

  toggleExport.textContent=t.export;
  btnExcel.textContent=t.excel;
  btnPDF.textContent=t.pdf;
  btnExportFamily.textContent=t.famExp;
  btnImportFamily.textContent=t.famImp;

  category.innerHTML="";
  for(const k in CAT){
    category.innerHTML+=`<option value="${k}">${CAT[k][langVal]}</option>`;
  }
}

/* ===== 折りたたみ ===== */
toggleExport.onclick=()=>exportArea.classList.toggle("hidden");

/* ===== 既存ロジック（省略なし） ===== */
btnAdd.onclick=()=>{menu.classList.add("hidden");add.classList.remove("hidden");};
btnSummary.onclick=()=>{menu.classList.add("hidden");summary.classList.remove("hidden");render();};
btnBack1.onclick=btnBack2.onclick=()=>{add.classList.add("hidden");summary.classList.add("hidden");menu.classList.remove("hidden");};

btnSave.onclick=()=>{
  const v=Number(amount.value);
  if(!v)return;
  const d=load();
  d.push({id:Date.now(),month:new Date().toISOString().slice(0,7),category:category.value,amount:v});
  saveAll(d);amount.value="";menu.classList.remove("hidden");add.classList.add("hidden");
};

function render(){
  const d=load();
  const ms=[...new Set(d.map(x=>x.month))].sort().reverse();
  month.innerHTML=ms.map(m=>`<option>${m}</option>`).join("");
  if(!month.value&&ms.length)month.value=ms[0];
  const f=d.filter(x=>x.month===month.value);
  monthTotal.textContent=`${f.reduce((a,b)=>a+b.amount,0)} ${currency.value}`;

  const bc={};
  f.forEach(x=>bc[x.category]=(bc[x.category]||0)+x.amount);
  categoryTotal.innerHTML=Object.keys(bc).map(k=>`
    <div class="breakdown"><span>${CAT[k][langVal]}</span><span>${bc[k]} ${currency.value}</span></div>
  `).join("");

  list.innerHTML=f.map(x=>`
    <div class="expense" onclick="toggle(${x.id})">
      <div class="category">${CAT[x.category][langVal]}</div>
      <div class="amount">${x.amount} ${currency.value}</div>
      ${activeId===x.id?`<button class="delete" onclick="del(${x.id});event.stopPropagation()">削除</button>`:""}
    </div>`).join("");
}

function toggle(id){activeId=activeId===id?null:id;render();}
function del(id){saveAll(load().filter(x=>x.id!==id));activeId=null;render();}
month.onchange=render;

/* ===== Export / Family（前回確定版そのまま） ===== */
btnExcel.onclick=()=>{const f=load().filter(x=>x.month===month.value);if(!f.length)return;
let csv="Month,Category,Amount,Currency\n";
f.forEach(x=>csv+=`${x.month},${CAT[x.category][langVal]},${x.amount},${currency.value}\n`);
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download=`kakeibo_${month.value}.csv`;a.click();};

btnPDF.onclick=()=>{const {jsPDF}=window.jspdf;const p=new jsPDF();
const f=load().filter(x=>x.month===month.value);if(!f.length)return;
let y=20;p.text(`${TEXT[langVal].title} ${month.value}`,10,y);y+=10;
f.forEach(x=>{p.text(`${CAT[x.category][langVal]} - ${x.amount} ${currency.value}`,10,y);y+=7;});
p.save(`kakeibo_${month.value}.pdf`);};

btnExportFamily.onclick=()=>{const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([JSON.stringify(load(),null,2)],{type:"application/json"}));
a.download="kakeibo_family_share.json";a.click();};

btnImportFamily.onclick=()=>familyFile.click();
familyFile.onchange=e=>{const r=new FileReader();
r.onload=()=>{const imp=JSON.parse(r.result);const cur=load();const ids=new Set(cur.map(x=>x.id));
imp.forEach(x=>!ids.has(x.id)&&cur.push(x));saveAll(cur);render();};
r.readAsText(e.target.files[0]);};

/* ===== 初期化 ===== */
lang.innerHTML=`<option value="ja">日本語</option><option value="en">English</option><option value="ko">한국어</option>`;
lang.value=langVal;
lang.onchange=()=>{langVal=lang.value;localStorage.setItem("lang",langVal);applyLang();render();};
applyLang();
</script>
</body>
</html>
