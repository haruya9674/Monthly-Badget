<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#4CAF93">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#F4F6F5;}
header{background:#4CAF93;color:#fff;padding:18px;font-size:22px;text-align:center;font-weight:600;}
.container{padding:20px;}
select,input,button{width:100%;padding:14px;font-size:16px;border-radius:12px;border:none;margin-top:12px;}
input{border:1px solid #ccc;}
button{background:#4CAF93;color:#fff;font-weight:bold;}
button.back{background:#ddd;color:#333;}
button.sub{background:#eee;color:#555;font-weight:500;}
button.delete{background:#E57373;margin-top:6px;font-size:13px;}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;}
.hidden{display:none;}
.topTotal{font-size:36px;font-weight:800;text-align:center;}
.topMonth{font-size:14px;color:#666;text-align:center;margin-bottom:12px;}
.breakdown{display:flex;justify-content:space-between;font-size:14px;margin:4px 0;}
.expense{border-bottom:1px solid #eee;padding:6px 0;}
.expenseRow{display:flex;justify-content:space-between;align-items:center;}
.date{font-size:12px;color:#999;width:80px;}
.amount{font-size:18px;font-weight:600;}
.category{font-size:13px;color:#666;}
</style>
</head>

<body>
<header id="title"></header>

<div class="container">

<div class="card">
<select id="lang"></select>
<select id="currency">
<option>MYR</option><option>JPY</option><option>KRW</option><option>AUD</option>
</select>
</div>

<div id="menu" class="card">
<div id="topTotal" class="topTotal"></div>
<div id="topMonth" class="topMonth"></div>
<button id="btnAdd"></button>
<button id="btnSummary"></button>
</div>

<div id="add" class="card hidden">
<select id="category"></select>
<input id="sub" placeholder="Detail">
<input type="number" id="amount">
<button id="btnSave"></button>
<button class="back" id="btnBack1"></button>
</div>

<div id="summary" class="card hidden">
<select id="month"></select>
<div id="monthTotal" class="topTotal"></div>
<div id="categoryTotal"></div>

<button class="sub" id="btnToggleExport"></button>

<div id="exportArea" class="hidden">
<button class="sub" id="btnExportFamily">Family Export</button>
<button class="sub" id="btnImportFamily">Family Import</button>
<button class="sub" id="btnImportPayPay">PayPay CSV</button>
<input type="file" id="fileFamily" accept=".json" hidden>
<input type="file" id="filePayPay" accept=".csv" hidden>
</div>

<button class="back" id="btnBack2"></button>
<div id="list"></div>
</div>

</div>

<script>
/* ===== TEXT ===== */
const TEXT={
ja:{title:"家計簿",add:"支出を入力",summary:"集計を見る",save:"保存",back:"戻る",export:"エクスポート / 共有"},
en:{title:"Expense Tracker",add:"Add Expense",summary:"View Summary",save:"Save",back:"Back",export:"Export / Share"},
ko:{title:"가계부",add:"지출 입력",summary:"집계 보기",save:"저장",back:"뒤로",export:"내보내기 / 공유"}
};

/* ===== CATEGORY MASTER ===== */
const DEFAULT_CAT={
food:{ja:"食費",en:"Food",ko:"식비"},
rent:{ja:"家賃",en:"Rent",ko:"월세"},
gas:{ja:"ガソリン代",en:"Gas",ko:"주유비"},
utilities:{ja:"光熱費",en:"Utilities",ko:"공과금"},
internet:{ja:"インターネット",en:"Internet",ko:"인터넷"},
shopping:{ja:"買い物",en:"Shopping",ko:"쇼핑"},
transfer:{ja:"トランスファー",en:"Transfer",ko:"이체"},
other:{ja:"その他",en:"Other",ko:"기타"}
};

const CAT_KEY="kakeibo_categories";
const DATA_KEY="kakeibo_data";

const loadCat=()=>JSON.parse(localStorage.getItem(CAT_KEY)||JSON.stringify(DEFAULT_CAT));
const saveCat=d=>localStorage.setItem(CAT_KEY,JSON.stringify(d));

const load=()=>JSON.parse(localStorage.getItem(DATA_KEY)||"[]");
const save=d=>localStorage.setItem(DATA_KEY,JSON.stringify(d));

let langVal=localStorage.getItem("lang")||"ja";

/* ===== INIT ===== */
function applyLang(){
const t=TEXT[langVal];
title.textContent=t.title;
btnAdd.textContent=t.add;
btnSummary.textContent=t.summary;
btnSave.textContent=t.save;
btnBack1.textContent=btnBack2.textContent=t.back;
btnToggleExport.textContent=t.export;
renderCategorySelect();
}

function renderCategorySelect(){
const cat=loadCat();
category.innerHTML=Object.keys(cat).map(k=>
`<option value="${k}">${cat[k][langVal]}</option>`
).join("");
}

function currentMonth(){
return new Date().toISOString().slice(0,7);
}

/* ===== TOP ===== */
function renderTop(){
const d=load().filter(x=>x.month===currentMonth() && x.category!=="transfer");
const sum=d.reduce((a,b)=>a+b.amount,0);
topTotal.textContent=`${sum.toFixed(2)} ${currency.value}`;
topMonth.textContent=currentMonth();
}

/* ===== ADD ===== */
btnAdd.onclick=()=>{menu.classList.add("hidden");add.classList.remove("hidden");};
btnSave.onclick=()=>{
const d=load();
d.push({
id:Date.now()+"_"+Math.random(),
date:new Date().toISOString().slice(0,10),
month:currentMonth(),
category:category.value,
sub:sub.value,
amount:Number(amount.value)
});
save(d);
amount.value=sub.value="";
add.classList.add("hidden");
menu.classList.remove("hidden");
renderTop();
};

/* ===== SUMMARY ===== */
btnSummary.onclick=()=>{
menu.classList.add("hidden");
summary.classList.remove("hidden");
renderSummary();
};

function renderSummary(){
const d=load();
const months=[...new Set(d.map(x=>x.month))].sort().reverse();
month.innerHTML=months.map(m=>`<option>${m}</option>`).join("");
const sel=month.value||months[0];
month.value=sel;

const f=d.filter(x=>x.month===sel);
const cat=loadCat();
let sum=0,bc={};

f.forEach(x=>{
if(x.category!=="transfer"){
sum+=x.amount;
bc[x.category]=(bc[x.category]||0)+x.amount;
}
});

monthTotal.textContent=`${sum.toFixed(2)} ${currency.value}`;
categoryTotal.innerHTML=Object.keys(bc).map(k=>`
<div class="breakdown">
<span>${cat[k][langVal]}</span>
<span>${bc[k].toFixed(2)}</span>
</div>`).join("");

list.innerHTML=f.map(x=>`
<div class="expense">
<div class="expenseRow">
<span class="date">${x.date}</span>
<span class="amount">${x.amount.toFixed(2)}</span>
</div>
<div class="category">${cat[x.category][langVal]} ${x.sub||""}</div>
</div>`).join("");
}

/* ===== EXPORT / IMPORT ===== */
btnToggleExport.onclick=()=>exportArea.classList.toggle("hidden");

btnExportFamily.onclick=()=>{
const blob=new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="kakeibo_family.json";
a.click();
};

btnImportFamily.onclick=()=>fileFamily.click();
fileFamily.onchange=e=>{
const r=new FileReader();
r.onload=()=>{
const cur=load();
const imp=JSON.parse(r.result);
const ids=new Set(cur.map(x=>x.id));
imp.forEach(x=>{if(!ids.has(x.id))cur.push(x);});
save(cur);
renderSummary();renderTop();
};
r.readAsText(e.target.files[0]);
};

btnImportPayPay.onclick=()=>filePayPay.click();
filePayPay.onchange=e=>{
const r=new FileReader();
r.onload=()=>{
const cur=load();
r.result.split(/\r?\n/).slice(1).forEach(l=>{
const c=l.split(",");
if(c.length<3)return;
const date=c[0].replace(/\//g,"-");
const amt=Math.abs(Number(c[2]));
cur.push({
id:"pp_"+Date.now(),
date,
month:date.slice(0,7),
category:"shopping",
sub:c[1],
amount:amt
});
});
save(cur);
renderSummary();renderTop();
};
r.readAsText(e.target.files[0],"utf-8");
};

/* ===== LANG ===== */
lang.innerHTML=`<option value="ja">日本語</option><option value="en">English</option><option value="ko">한국어</option>`;
lang.value=langVal;
lang.onchange=()=>{
langVal=lang.value;
localStorage.setItem("lang",langVal);
applyLang();renderSummary();renderTop();
};

btnBack1.onclick=btnBack2.onclick=()=>{
add.classList.add("hidden");
summary.classList.add("hidden");
menu.classList.remove("hidden");
renderTop();
};

applyLang();
renderTop();
</script>
</body>
</html>
