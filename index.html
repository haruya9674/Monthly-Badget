<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Family Budget</title>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f5f6fa;margin:0;padding:16px}
h1{text-align:center}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px}
select,input,button{width:100%;font-size:18px;padding:10px;margin-top:8px}
button{background:#4a6cf7;color:#fff;border:none;border-radius:10px}
.list{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
.total{font-size:22px;font-weight:bold}
.small{font-size:14px;color:#666}
details button{margin-top:6px;background:#888}
</style>
</head>

<body>

<h1 id="title"></h1>

<div class="card">
  <select id="lang"></select>
  <select id="currency"></select>
</div>

<div class="card">
  <select id="category"></select>
  <input id="customCategory" style="display:none">
  <input id="amount" type="number" step="0.01">
  <button id="saveBtn"></button>
</div>

<div class="card">
  <select id="month"></select>
  <div class="total" id="monthTotal"></div>
  <div class="total small" id="transferTotal"></div>
</div>

<div class="card">
  <div id="list"></div>
</div>

<div class="card">
  <details>
    <summary id="shareTitle"></summary>
    <button onclick="exportJSON()">Export JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <button onclick="document.getElementById('importFile').click()">Import JSON</button>
  </details>
</div>

<script>
/* ===== 言語 ===== */
const T={
 ja:{title:"家計簿",save:"保存",share:"家族共有",total:"今月の支出",transfer:"Transfer合計",
 categories:["Food","Utilities","Internet","Mobile","Education","Shopping","Gasoline","Eating Out","Travel","Rent","Transfer","Other"]},
 en:{title:"Budget",save:"Save",share:"Family Share",total:"Monthly Total",transfer:"Transfer Total",
 categories:["Food","Utilities","Internet","Mobile","Education","Shopping","Gasoline","Eating Out","Travel","Rent","Transfer","Other"]},
 ko:{title:"가계부",save:"저장",share:"가족 공유",total:"월 지출",transfer:"이체 합계",
 categories:["식비","공과금","인터넷","휴대폰","교육","쇼핑","주유비","외식","여행","월세","이체","기타"]}
};

/* ===== 通貨 ===== */
const C={MYR:"MYR",JPY:"JPY",KRW:"KRW",AUD:"AUD"};

/* ===== Storage ===== */
const KEY="BUDGET_DATA_V4";
const load=()=>JSON.parse(localStorage.getItem(KEY)||"[]");
const save=d=>localStorage.setItem(KEY,JSON.stringify(d));

/* ===== Utils ===== */
const uid=()=>Date.now()+"_"+Math.random().toString(36).slice(2,6);

/* ===== DOM ===== */
const lang=document.getElementById("lang");
const currency=document.getElementById("currency");
const category=document.getElementById("category");
const customCategory=document.getElementById("customCategory");
const amount=document.getElementById("amount");
const month=document.getElementById("month");
const list=document.getElementById("list");

/* ===== 初期 ===== */
Object.keys(T).forEach(k=>lang.innerHTML+=`<option>${k}</option>`);
Object.keys(C).forEach(k=>currency.innerHTML+=`<option>${k}</option>`);

lang.onchange=renderUI;
category.onchange=()=>customCategory.style.display=category.value==="Other"?"block":"none";

/* ===== UI ===== */
function renderUI(){
 const t=T[lang.value];
 title.textContent=t.title;
 saveBtn.textContent=t.save;
 shareTitle.textContent=t.share;
 category.innerHTML=t.categories.map(c=>`<option>${c}</option>`).join("");
 render();
}

/* ===== 保存 ===== */
saveBtn.onclick=()=>{
 const data=load();
 data.push({
  id:uid(),
  month:new Date().toISOString().slice(0,7),
  category:category.value==="Other"?customCategory.value:category.value,
  rawCategory:category.value,
  amount:parseFloat(amount.value),
  currency:currency.value
 });
 save(data);
 amount.value="";
 render();
};

/* ===== 表示 ===== */
function render(){
 const data=load();
 const months=[...new Set(data.map(d=>d.month))];
 month.innerHTML=months.map(m=>`<option>${m}</option>`).join("");

 const f=data.filter(d=>d.month===month.value);
 let sum=0,transfer=0;
 list.innerHTML="";

 f.forEach(d=>{
  d.rawCategory==="Transfer"?transfer+=d.amount:sum+=d.amount;
  const div=document.createElement("div");
  div.className="list";
  div.innerHTML=`<span>${d.category}</span><span>${d.amount.toFixed(2)} ${d.currency}</span>`;
  div.onclick=()=>{if(confirm("Delete?")){save(load().filter(x=>x.id!==d.id));render();}};
  list.appendChild(div);
 });

 monthTotal.textContent=`${T[lang.value].total}: ${sum.toFixed(2)} ${currency.value}`;
 transferTotal.textContent=`${T[lang.value].transfer}: ${transfer.toFixed(2)} ${currency.value}`;
}

/* ===== Export / Import ===== */
function exportJSON(){
 const blob=new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="budget.json";
 a.click();
}

document.getElementById("importFile").onchange=e=>{
 const file=e.target.files[0];
 if(!file)return;
 const reader=new FileReader();
 reader.onload=()=>{
  const imported=JSON.parse(reader.result);
  const current=load();
  const map=new Map(current.map(d=>[d.id,d]));
  imported.forEach(d=>{if(!map.has(d.id))current.push(d)});
  save(current);
  render();
 };
 reader.readAsText(file);
};

renderUI();
</script>
</body>
</html>
