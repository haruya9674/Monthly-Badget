<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json?v=FINAL_2">
<meta name="theme-color" content="#4CAF93">

<!-- VERSION: FINAL_UX_2026_01_20 -->

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#F4F6F5;
}
header{
  background:#4CAF93;
  color:#fff;
  padding:18px;
  font-size:24px;
  text-align:center;
  font-weight:600;
}
.container{ padding:20px; }

select,input,button{
  width:100%;
  padding:14px;
  font-size:18px;
  border-radius:12px;
  border:none;
  margin-top:12px;
}
input{ border:1px solid #ccc; background:#fff; }
button{
  background:#4CAF93;
  color:#fff;
  font-weight:bold;
}
button.back{
  background:#ddd;
  color:#333;
}

.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
.hidden{ display:none; }

/* ===== 家計簿リスト ===== */
.expense{
  padding:16px 0;
  border-bottom:1px solid #eee;
  text-align:center;
}
.expense:last-child{ border-bottom:none; }
.expense .category{
  font-size:18px;
  color:#666;
}
.expense .amount{
  font-size:28px;
  font-weight:600;
  margin-top:4px;
}
.hint{
  font-size:12px;
  color:#999;
  text-align:center;
  margin-top:10px;
}
</style>
</head>

<body>

<header>家計簿</header>

<div class="container">

<div id="menu" class="card">
  <select id="currency">
    <option value="MYR">MYR</option>
    <option value="JPY">JPY</option>
    <option value="KRW">KRW</option>
    <option value="AUD">AUD</option>
  </select>
  <button onclick="openAdd()">支出を入力</button>
  <button onclick="openSummary()">集計を見る</button>
</div>

<div id="add" class="card hidden">
  <select id="category">
    <option value="food">食費</option>
    <option value="rent">家賃</option>
    <option value="utilities">光熱費</option>
    <option value="internet">インターネット</option>
    <option value="phone">携帯</option>
    <option value="school">学費</option>
    <option value="shopping">買い物</option>
    <option value="other">その他</option>
  </select>
  <input type="number" id="amount" placeholder="金額">
  <button onclick="save()">保存</button>
  <button class="back" onclick="back()">戻る</button>
</div>

<div id="summary" class="card hidden">
  <select id="month"></select>
  <div id="list"></div>
  <div class="hint">※ 長押しで削除</div>
  <button class="back" onclick="back()">戻る</button>
</div>

</div>

<script>
/* ==== Service Worker 強制最新 ==== */
if('serviceWorker' in navigator){
  navigator.serviceWorker.getRegistrations().then(rs=>{
    rs.forEach(r=>r.unregister());
  });
}

/* ==== Storage ==== */
function load(){
  return JSON.parse(localStorage.getItem("kakeibo_data")||"[]");
}
function saveAll(d){
  localStorage.setItem("kakeibo_data",JSON.stringify(d));
}

/* ==== 画面 ==== */
function openAdd(){
  menu.classList.add("hidden");
  add.classList.remove("hidden");
}
function openSummary(){
  menu.classList.add("hidden");
  summary.classList.remove("hidden");
  render();
}
function back(){
  add.classList.add("hidden");
  summary.classList.add("hidden");
  menu.classList.remove("hidden");
}

/* ==== 保存 ==== */
function save(){
  const v=Number(amount.value);
  if(!v) return;

  const data=load();
  data.push({
    id:Date.now(),
    month:new Date().toISOString().slice(0,7),
    category:category.value,
    amount:v
  });
  saveAll(data);

  amount.value="";
  back(); // 保存後は自然に戻る
}

/* ==== 表示 ==== */
function render(){
  const data=load();
  const months=[...new Set(data.map(d=>d.month))].sort().reverse();
  month.innerHTML=months.map(m=>`<option>${m}</option>`).join("");

  const filtered=data.filter(d=>d.month===month.value);
  list.innerHTML=filtered.map(d=>`
    <div class="expense" oncontextmenu="remove(${d.id});return false;">
      <div class="category">${d.category}</div>
      <div class="amount">${d.amount} ${currency.value}</div>
    </div>
  `).join("");
}

month.onchange=render;

/* ==== 長押し削除 ==== */
function remove(id){
  if(!confirm("この支出を削除しますか？")) return;
  const data=load().filter(d=>d.id!==id);
  saveAll(data);
  render();
}
</script>

</body>
</html>
