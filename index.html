<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json?v=FINAL">
<meta name="theme-color" content="#4CAF93">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#F4F6F5;
}
header{
  background:#4CAF93;
  color:#fff;
  padding:18px;
  font-size:22px;
  text-align:center;
  font-weight:600;
}
.container{ padding:20px; }
select,input,button{
  width:100%;
  padding:14px;
  font-size:16px;
  border-radius:12px;
  border:none;
  margin-top:12px;
}
input{ border:1px solid #ccc; background:#fff; }
button{ background:#4CAF93;color:#fff;font-weight:bold; }
button.back{ background:#ddd;color:#333; }
button.delete{ background:#E57373;margin-top:8px; }
.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
.hidden{ display:none; }
.expense{
  padding:16px 0;
  border-bottom:1px solid #eee;
  text-align:center;
}
.expense:last-child{ border-bottom:none; }
.category{ font-size:15px;color:#666; }
.amount{ font-size:26px;font-weight:600;margin-top:4px; }
.total{
  font-size:28px;
  font-weight:700;
  text-align:center;
  margin:10px 0;
}
.breakdown{
  font-size:15px;
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}
</style>
</head>

<body>
<header id="title"></header>

<div class="container">

<div class="card">
  <select id="lang"></select>
  <select id="currency">
    <option value="MYR">MYR</option>
    <option value="JPY">JPY</option>
    <option value="KRW">KRW</option>
    <option value="AUD">AUD</option>
  </select>
</div>

<div id="menu" class="card">
  <button id="btnAdd"></button>
  <button id="btnSummary"></button>
</div>

<div id="add" class="card hidden">
  <select id="category"></select>
  <input type="number" id="amount">
  <button id="btnSave"></button>
  <button class="back" id="btnBack1"></button>
</div>

<div id="summary" class="card hidden">
  <select id="month"></select>

  <div id="monthTotal" class="total"></div>
  <div id="categoryTotal"></div>

  <hr>

  <div id="list"></div>

  <button id="btnExcel">Export Excel</button>
  <button id="btnPDF">Export PDF</button>
  <button id="btnExportFamily">家族共有用に書き出し</button>
  <button id="btnImportFamily">家族共有データを読み込み</button>
  <input type="file" id="familyFile" accept=".json" hidden>

  <button class="back" id="btnBack2"></button>
</div>

</div>

<script>
/* ===== 言語 ===== */
const TEXT={
  ja:{title:"家計簿",add:"支出を入力",summary:"集計を見る",save:"保存",back:"戻る",amount:"金額"},
  en:{title:"Expense Tracker",add:"Add Expense",summary:"View Summary",save:"Save",back:"Back",amount:"Amount"},
  ko:{title:"가계부",add:"지출 입력",summary:"집계 보기",save:"저장",back:"뒤로",amount:"금액"}
};

const CAT={
  food:{ja:"食費",en:"Food",ko:"식비"},
  rent:{ja:"家賃",en:"Rent",ko:"월세"},
  utilities:{ja:"光熱費",en:"Utilities",ko:"공과금"},
  internet:{ja:"インターネット",en:"Internet",ko:"인터넷"},
  phone:{ja:"携帯",en:"Mobile",ko:"휴대폰"},
  school:{ja:"学費",en:"School",ko:"학비"},
  shopping:{ja:"買い物",en:"Shopping",ko:"쇼핑"},
  other:{ja:"その他",en:"Other",ko:"기타"}
};

let langVal = localStorage.getItem("lang") || "ja";
let activeId = null;

/* ===== 保存 ===== */
const load = () => JSON.parse(localStorage.getItem("kakeibo_data") || "[]");
const saveAll = d => localStorage.setItem("kakeibo_data", JSON.stringify(d));

/* ===== 言語反映 ===== */
function applyLang(){
  const t = TEXT[langVal];
  title.textContent = t.title;
  btnAdd.textContent = t.add;
  btnSummary.textContent = t.summary;
  btnSave.textContent = t.save;
  btnBack1.textContent = btnBack2.textContent = t.back;
  amount.placeholder = t.amount;

  category.innerHTML = "";
  for(const k in CAT){
    category.innerHTML += `<option value="${k}">${CAT[k][langVal]}</option>`;
  }
}

/* ===== 画面遷移 ===== */
function openAdd(){ menu.classList.add("hidden"); add.classList.remove("hidden"); }
function openSummary(){ menu.classList.add("hidden"); summary.classList.remove("hidden"); render(); }
function back(){ add.classList.add("hidden"); summary.classList.add("hidden"); menu.classList.remove("hidden"); }

btnAdd.onclick = openAdd;
btnSummary.onclick = openSummary;
btnBack1.onclick = btnBack2.onclick = back;

/* ===== 保存 ===== */
btnSave.onclick = ()=>{
  const v = Number(amount.value);
  if(!v) return;
  const data = load();
  data.push({
    id:Date.now(),
    month:new Date().toISOString().slice(0,7),
    category:category.value,
    amount:v
  });
  saveAll(data);
  amount.value="";
  back();
};

/* ===== 表示 ===== */
function render(){
  const data = load();
  const months = [...new Set(data.map(d=>d.month))].sort().reverse();
  month.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");
  if(!month.value && months.length) month.value = months[0];

  const f = data.filter(d=>d.month===month.value);
  const sum = f.reduce((a,b)=>a+b.amount,0);
  monthTotal.textContent = `${sum} ${currency.value}`;

  const byCat = {};
  f.forEach(d=>byCat[d.category]=(byCat[d.category]||0)+d.amount);

  categoryTotal.innerHTML = Object.keys(byCat).map(k=>`
    <div class="breakdown">
      <span>${CAT[k][langVal]}</span>
      <span>${byCat[k]} ${currency.value}</span>
    </div>
  `).join("");

  list.innerHTML = f.map(d=>`
    <div class="expense" onclick="toggle(${d.id})">
      <div class="category">${CAT[d.category][langVal]}</div>
      <div class="amount">${d.amount} ${currency.value}</div>
      ${activeId===d.id
        ? `<button class="delete" onclick="del(${d.id});event.stopPropagation()">削除</button>`
        : ""
      }
    </div>
  `).join("");
}

function toggle(id){ activeId = activeId===id ? null : id; render(); }
function del(id){ saveAll(load().filter(d=>d.id!==id)); activeId=null; render(); }
month.onchange = render;

/* ===== Excel ===== */
btnExcel.onclick = ()=>{
  const data = load().filter(d=>d.month===month.value);
  if(!data.length) return;
  let csv = "Month,Category,Amount,Currency\n";
  data.forEach(d=>{
    csv += `${d.month},${CAT[d.category][langVal]},${d.amount},${currency.value}\n`;
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`kakeibo_${month.value}.csv`;
  a.click();
};

/* ===== PDF ===== */
btnPDF.onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const data = load().filter(d=>d.month===month.value);
  if(!data.length) return;

  let y=20;
  pdf.text(`${TEXT[langVal].title} ${month.value}`,10,y); y+=10;
  const sum=data.reduce((a,b)=>a+b.amount,0);
  pdf.text(`Total: ${sum} ${currency.value}`,10,y); y+=10;

  data.forEach(d=>{
    pdf.text(`${CAT[d.category][langVal]} - ${d.amount} ${currency.value}`,10,y);
    y+=7;
  });
  pdf.save(`kakeibo_${month.value}.pdf`);
};

/* ===== 家族共有 ===== */
btnExportFamily.onclick = ()=>{
  const blob=new Blob([JSON.stringify(load(),null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="kakeibo_family_share.json";
  a.click();
};

btnImportFamily.onclick=()=>familyFile.click();
familyFile.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{
    const imported=JSON.parse(r.result);
    const cur=load();
    const ids=new Set(cur.map(d=>d.id));
    imported.forEach(d=>{ if(!ids.has(d.id)) cur.push(d); });
    saveAll(cur);
    render();
  };
  r.readAsText(e.target.files[0]);
};

/* ===== 初期化 ===== */
lang.innerHTML=`
<option value="ja">日本語</option>
<option value="en">English</option>
<option value="ko">한국어</option>`;
lang.value=langVal;
lang.onchange=()=>{
  langVal=lang.value;
  localStorage.setItem("lang",langVal);
  applyLang(); render();
};

applyLang();
</script>
</body>
</html>
