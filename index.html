<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json?v=FINAL">
<meta name="theme-color" content="#4CAF93">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#F4F6F5;}
header{background:#4CAF93;color:#fff;padding:18px;font-size:22px;text-align:center;font-weight:600;}
.container{padding:20px;}
select,input,button{width:100%;padding:14px;font-size:16px;border-radius:12px;border:none;margin-top:12px;}
input{border:1px solid #ccc;background:#fff;}
button{background:#4CAF93;color:#fff;font-weight:bold;}
button.back{background:#ddd;color:#333;}
button.sub{background:#eee;color:#555;font-weight:500;font-size:14px;}
button.delete{background:#E57373;margin-top:6px;font-size:13px;}
.card{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;}
.hidden{display:none;}
.total{font-size:28px;font-weight:700;text-align:center;margin:10px 0;}
.breakdown{font-size:15px;display:flex;justify-content:space-between;margin:4px 0;}
.expense{padding:6px 0;border-bottom:1px solid #eee;}
.category{font-size:13px;color:#666;}
.amount{font-size:20px;font-weight:600;}
.date{font-size:12px;color:#999;margin-right:6px;}

.topTotal{font-size:36px;font-weight:800;text-align:center;margin:6px 0;}
.topMonthLabel{font-size:14px;color:#666;text-align:center;margin-bottom:14px;}

.catRow{display:flex;gap:8px;margin-top:10px;}
.catRow span{width:40%;font-size:14px;color:#555;}
.catRow input{width:60%;padding:10px;border-radius:10px;border:1px solid #ccc;}
</style>
</head>

<body>
<header id="title"></header>

<div class="container">

<div class="card">
  <select id="lang"></select>
  <select id="currency">
    <option>MYR</option>
    <option>JPY</option>
    <option>KRW</option>
    <option>AUD</option>
  </select>
</div>

<div id="menu" class="card">
  <div id="topMonthTotal" class="topTotal"></div>
  <div id="topMonthLabel" class="topMonthLabel"></div>
  <button id="btnAdd"></button>
  <button id="btnSummary"></button>
  <button class="sub" id="btnEditCategory"></button>
</div>

<div id="add" class="card hidden">
  <select id="category"></select>
  <input id="otherName" class="hidden">
  <input type="number" id="amount" step="0.01">
  <button id="btnSave"></button>
  <button class="back" id="btnBack1"></button>
</div>

<div id="editCategory" class="card hidden">
  <h3 id="catEditTitle" style="text-align:center;"></h3>
  <select id="editLang"></select>
  <div id="categoryEditor"></div>
  <button id="btnSaveCategory"></button>
  <button class="back" id="btnBackCategory"></button>
</div>

<div id="summary" class="card hidden">
  <select id="month"></select>
  <div id="monthTotal" class="total"></div>
  <div id="transferTotal" class="total" style="font-size:18px;color:#777;"></div>
  <div id="categoryTotal"></div>

  <button class="sub" id="toggleExport"></button>
  <div id="exportArea" class="hidden">
    <button class="sub" id="btnExportFamily"></button>
    <button class="sub" id="btnImportFamily"></button>
    <button class="sub" id="btnImportPayPay">PayPay CSV</button>
    <input type="file" id="familyFile" hidden>
    <input type="file" id="paypayFile" hidden>
  </div>

  <button class="back" id="btnBack2"></button>
  <div id="list"></div>
</div>

</div>

<script>
/* ========= TEXT ========= */
const TEXT={
 ja:{title:"家計簿",add:"支出を入力",summary:"集計を見る",save:"保存",back:"戻る",
     editCat:"カテゴリ名を編集",catEditTitle:"カテゴリ名編集",saveCat:"保存",
     export:"エクスポート / 共有",famExp:"家族共有用に書き出し",
     famImp:"家族データを読み込み",other:"詳細",monthTotalLabel:"今月の支出"},
 en:{title:"Expense Tracker",add:"Add Expense",summary:"View Summary",save:"Save",back:"Back",
     editCat:"Edit Category",catEditTitle:"Edit Category",saveCat:"Save",
     export:"Export / Share",famExp:"Export for Family",
     famImp:"Import Family Data",other:"Detail",monthTotalLabel:"This Month"},
 ko:{title:"가계부",add:"지출 입력",summary:"집계 보기",save:"저장",back:"뒤로",
     editCat:"카테고리 편집",catEditTitle:"카테고리 편집",saveCat:"저장",
     export:"내보내기 / 공유",famExp:"가족 공유",
     famImp:"가족 데이터",other:"상세",monthTotalLabel:"이번 달"}
};

/* ========= CATEGORY ========= */
const CAT_DEFAULT={
 food:{ja:"食費",en:"Food",ko:"식비"},
 rent:{ja:"家賃",en:"Rent",ko:"월세"},
 gas:{ja:"ガソリン代",en:"Gasoline",ko:"주유비"},
 utilities:{ja:"光熱費",en:"Utilities",ko:"공과금"},
 internet:{ja:"インターネット",en:"Internet",ko:"인터넷"},
 phone:{ja:"携帯",en:"Mobile",ko:"휴대폰"},
 school:{ja:"学費",en:"School",ko:"학비"},
 shopping:{ja:"買い物",en:"Shopping",ko:"쇼핑"},
 transfer:{ja:"トランスファー",en:"Transfer",ko:"이체"},
 other:{ja:"その他",en:"Other",ko:"기타"}
};

const CAT_KEY="kakeibo_cat_labels";
const CAT=JSON.parse(localStorage.getItem(CAT_KEY))||structuredClone(CAT_DEFAULT);
const saveCats=()=>localStorage.setItem(CAT_KEY,JSON.stringify(CAT));

/* ========= DATA ========= */
const KEY="kakeibo_data_FINAL";
const load=()=>JSON.parse(localStorage.getItem(KEY)||"[]");
const saveAll=d=>localStorage.setItem(KEY,JSON.stringify(d));
const uid=()=>Date.now()+"_"+Math.random().toString(36).slice(2,6);
const currentMonth=()=>new Date().toISOString().slice(0,7);

let langVal=localStorage.getItem("lang")||"ja";
let activeId=null;

/* ========= Language ========= */
function applyLang(){
 const t=TEXT[langVal];
 title.textContent=t.title;
 btnAdd.textContent=t.add;
 btnSummary.textContent=t.summary;
 btnSave.textContent=t.save;
 btnBack1.textContent=btnBack2.textContent=btnBackCategory.textContent=t.back;
 btnEditCategory.textContent=t.editCat;
 catEditTitle.textContent=t.catEditTitle;
 btnSaveCategory.textContent=t.saveCat;
 toggleExport.textContent=t.export;
 btnExportFamily.textContent=t.famExp;
 btnImportFamily.textContent=t.famImp;
 otherName.placeholder=t.other;

 category.innerHTML="";
 for(const k in CAT){
  category.innerHTML+=`<option value="${k}">${CAT[k][langVal]}</option>`;
 }
}

/* ========= TOP ========= */
function renderTop(){
 const m=currentMonth();
 const sum=load().filter(x=>x.month===m&&x.category!=="transfer")
 .reduce((a,b)=>a+b.amount,0);
 topMonthTotal.textContent=`${sum.toFixed(2)} ${currency.value}`;
 topMonthLabel.textContent=`${TEXT[langVal].monthTotalLabel} · ${m}`;
}

/* ========= SUMMARY (完全修復) ========= */
function render(){
 const d=load();
 const ms=[...new Set(d.map(x=>x.month))].sort().reverse();
 month.innerHTML=ms.map(m=>`<option>${m}</option>`).join("");
 if(!month.value) month.value=ms[0];

 const f=d.filter(x=>x.month===month.value);
 let sum=0,transfer=0,bc={};

 f.forEach(x=>{
  if(x.category==="transfer") transfer+=x.amount;
  else{
   sum+=x.amount;
   bc[x.category]=(bc[x.category]||0)+x.amount;
  }
 });

 monthTotal.textContent=`${sum.toFixed(2)} ${currency.value}`;
 transferTotal.textContent=`Transfer: ${transfer.toFixed(2)} ${currency.value}`;

 categoryTotal.innerHTML=Object.keys(bc).map(k=>`
  <div class="breakdown">
   <span>${CAT[k][langVal]}</span>
   <span>${bc[k].toFixed(2)} ${currency.value}</span>
  </div>`).join("");

 list.innerHTML=f.map(x=>`
  <div class="expense" onclick="toggle('${x.id}')">
   <div>
    <span class="date">${x.date}</span>
    <span class="category">${CAT[x.category][langVal]}</span>
   </div>
   <div class="amount">${x.amount.toFixed(2)} ${currency.value}</div>
   ${activeId===x.id?`<button class="delete" onclick="del('${x.id}');event.stopPropagation()">削除</button>`:""}
  </div>`).join("");
}

function toggle(id){activeId=activeId===id?null:id;render();}
function del(id){saveAll(load().filter(x=>x.id!==id));activeId=null;render();renderTop();}
month.onchange=render;

/* ========= NAV ========= */
btnAdd.onclick=()=>{menu.classList.add("hidden");add.classList.remove("hidden");};
btnSummary.onclick=()=>{menu.classList.add("hidden");summary.classList.remove("hidden");render();};
btnBack1.onclick=btnBack2.onclick=()=>{
 add.classList.add("hidden");summary.classList.add("hidden");
 menu.classList.remove("hidden");renderTop();
};

/* ========= SAVE ========= */
btnSave.onclick=()=>{
 const v=Number(amount.value); if(!v)return;
 const d=load();
 d.push({id:uid(),date:new Date().toISOString().slice(0,10),
 month:currentMonth(),category:category.value,sub:otherName.value,amount:v});
 saveAll(d);amount.value="";otherName.value="";
 menu.classList.remove("hidden");add.classList.add("hidden");renderTop();
};

/* ========= CATEGORY EDIT ========= */
btnEditCategory.onclick=()=>{
 menu.classList.add("hidden");
 editCategory.classList.remove("hidden");
 editLang.value=langVal;
 renderCategoryEditor();
};

btnBackCategory.onclick=()=>{
 editCategory.classList.add("hidden");
 menu.classList.remove("hidden");
 renderTop();
};

editLang.innerHTML=`<option value="ja">日本語</option><option value="en">English</option><option value="ko">한국어</option>`;
editLang.onchange=renderCategoryEditor;

function renderCategoryEditor(){
 const l=editLang.value;
 categoryEditor.innerHTML="";
 for(const k in CAT){
  categoryEditor.innerHTML+=`
   <div class="catRow">
    <span>${k}</span>
    <input data-key="${k}" value="${CAT[k][l]}">
   </div>`;
 }
}

btnSaveCategory.onclick=()=>{
 const l=editLang.value;
 document.querySelectorAll("#categoryEditor input").forEach(i=>{
  CAT[i.dataset.key][l]=i.value;
 });
 saveCats();applyLang();render();renderTop();
};

/* ========= INIT ========= */
lang.innerHTML=`<option value="ja">日本語</option><option value="en">English</option><option value="ko">한국어</option>`;
lang.value=langVal;
lang.onchange=()=>{langVal=lang.value;localStorage.setItem("lang",langVal);applyLang();render();renderTop();};

applyLang();
renderTop();
</script>
</body>
</html>
