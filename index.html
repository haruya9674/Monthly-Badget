<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Kakeibo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json?v=FINAL">
<meta name="theme-color" content="#4CAF93">

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#F4F6F5;}
header{background:#4CAF93;color:#fff;padding:18px;font-size:22px;text-align:center;font-weight:600;}
.container{padding:20px;}
select,input,button{width:100%;padding:12px;font-size:15px;border-radius:12px;border:none;margin-top:10px;}
input{border:1px solid #ccc;background:#fff;}
button{background:#4CAF93;color:#fff;font-weight:bold;}
button.back{background:#ddd;color:#333;}
button.sub{background:#eee;color:#555;font-weight:500;font-size:14px;}
button.delete{background:#E57373;margin-top:4px;font-size:12px;}
.card{background:#fff;border-radius:16px;padding:18px;margin-bottom:18px;}
.hidden{display:none;}
.total{font-size:26px;font-weight:700;text-align:center;margin:8px 0;}
.breakdown{font-size:14px;display:flex;justify-content:space-between;margin:3px 0;}

/* ===== Compact Transaction ===== */
.expense{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:6px 0;
 border-bottom:1px solid #eee;
}
.exp-left{text-align:left;}
.exp-right{text-align:right;}
.category{font-size:12px;color:#666;}
.amount{font-size:16px;font-weight:600;}
.date{font-size:11px;color:#aaa;}

.topTotal{font-size:34px;font-weight:800;text-align:center;margin:4px 0;}
.topMonthLabel{font-size:13px;color:#666;text-align:center;margin-bottom:12px;}
</style>
</head>

<body>
<header id="title"></header>
<div class="container">

<div class="card">
  <select id="lang"></select>
  <select id="currency">
    <option>MYR</option><option>JPY</option><option>KRW</option><option>AUD</option>
  </select>
  <button class="sub" id="btnCategoryManage">カテゴリ管理</button>
</div>

<div id="menu" class="card">
  <div id="topMonthTotal" class="topTotal"></div>
  <div id="topMonthLabel" class="topMonthLabel"></div>
  <button id="btnAdd"></button>
  <button id="btnSummary"></button>
</div>

<div id="add" class="card hidden">
  <select id="category"></select>
  <input id="otherName" class="hidden">
  <input type="number" id="amount" step="0.01">
  <button id="btnSave"></button>
  <button class="back" id="btnBack1"></button>
</div>

<div id="summary" class="card hidden">
  <select id="month"></select>
  <div id="monthTotal" class="total"></div>
  <div id="transferTotal" class="total" style="font-size:16px;color:#777;"></div>
  <div id="categoryTotal"></div>
  <button class="back" id="btnBack2"></button>
  <h4 style="text-align:center;margin:12px 0;">Transactions</h4>
  <div id="list"></div>
</div>

</div>

<script>
const KEY_DATA="kakeibo_data_FINAL";
const KEY_CAT="kakeibo_categories";

const BASE_CAT={
 food:{ja:"食費",en:"Food",ko:"식비"},
 rent:{ja:"家賃",en:"Rent",ko:"월세"},
 gas:{ja:"ガソリン代",en:"Gasoline",ko:"주유비"},
 utilities:{ja:"光熱費",en:"Utilities",ko:"공과금"},
 shopping:{ja:"買い物",en:"Shopping",ko:"쇼핑"},
 transfer:{ja:"振替",en:"Transfer",ko:"이체"},
 other:{ja:"その他",en:"Other",ko:"기타"}
};

let CAT=JSON.parse(localStorage.getItem(KEY_CAT))||BASE_CAT;

const load=()=>JSON.parse(localStorage.getItem(KEY_DATA)||"[]");
const saveAll=d=>localStorage.setItem(KEY_DATA,JSON.stringify(d));
const saveCat=()=>localStorage.setItem(KEY_CAT,JSON.stringify(CAT));
const uid=()=>Date.now()+"_"+Math.random().toString(36).slice(2,6);
const currentMonth=()=>new Date().toISOString().slice(0,7);

btnCategoryManage.onclick=()=>{
 const key=prompt("新しいカテゴリキー（英数字）");
 if(!key||CAT[key])return;
 const ja=prompt("日本語名");
 const en=prompt("English name");
 const ko=prompt("한국어 이름");
 CAT[key]={ja,en,ko};
 saveCat();
 applyCategory();
 alert("カテゴリ追加完了");
};

function applyCategory(){
 category.innerHTML="";
 Object.keys(CAT).forEach(k=>{
  category.innerHTML+=`<option value="${k}">${CAT[k][langVal]}</option>`;
 });
}

function renderTop(){
 const m=currentMonth();
 const sum=load().filter(x=>x.month===m && x.category!=="transfer")
   .reduce((a,b)=>a+b.amount,0);
 topMonthTotal.textContent=`${sum.toFixed(2)} ${currency.value}`;
 topMonthLabel.textContent=`${m}`;
}

function render(){
 const d=load();
 const f=d.filter(x=>x.month===month.value);
 list.innerHTML=f.map(x=>`
  <div class="expense">
   <div class="exp-left">
     <div class="category">${CAT[x.category]?.[langVal]||x.category}</div>
     <div class="date">${x.date}</div>
   </div>
   <div class="exp-right">
     <div class="amount">${x.amount.toFixed(2)} ${currency.value}</div>
   </div>
  </div>
 `).join("");
}

btnAdd.onclick=()=>{menu.classList.add("hidden");add.classList.remove("hidden");};
btnSummary.onclick=()=>{menu.classList.add("hidden");summary.classList.remove("hidden");month.value=currentMonth();render();};
btnBack1.onclick=btnBack2.onclick=()=>{add.classList.add("hidden");summary.classList.add("hidden");menu.classList.remove("hidden");renderTop();};

btnSave.onclick=()=>{
 const d=load();
 d.push({
  id:uid(),date:new Date().toISOString().slice(0,10),
  month:currentMonth(),category:category.value,
  amount:Number(amount.value)
 });
 saveAll(d);
 amount.value="";
 renderTop();
 menu.classList.remove("hidden");add.classList.add("hidden");
};

const TEXT={ja:{title:"家計簿",add:"支出を入力",summary:"集計"},en:{title:"Expense",add:"Add",summary:"Summary"},ko:{title:"가계부",add:"입력",summary:"집계"}};
let langVal=localStorage.getItem("lang")||"ja";
lang.innerHTML=`<option value="ja">日本語</option><option value="en">English</option><option value="ko">한국어</option>`;
lang.value=langVal;
lang.onchange=()=>{langVal=lang.value;localStorage.setItem("lang",langVal);applyCategory();renderTop();};

applyCategory();
renderTop();
</script>
</body>
</html>
